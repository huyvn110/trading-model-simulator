<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Model Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f7f6f3;
            --bg-tertiary: #edece9;
            --bg-hover: rgba(55, 53, 47, 0.08);
            --text-primary: #37352f;
            --text-secondary: #6b6b6b;
            --text-muted: #9b9b9b;
            --border-color: rgba(55, 53, 47, 0.12);
            --accent-color: #2383e2;
            --accent-light: rgba(35, 131, 226, 0.1);
            --success-color: #0f7b6c;
            --success-light: rgba(15, 123, 108, 0.1);
            --warning-color: #cb912f;
            --error-color: #eb5757;
        }

        [data-theme="dark"] {
            --bg-primary: #191919;
            --bg-secondary: #202020;
            --bg-tertiary: #2d2d2d;
            --bg-hover: rgba(255, 255, 255, 0.08);
            --text-primary: rgba(255, 255, 255, 0.9);
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-muted: rgba(255, 255, 255, 0.4);
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-light: rgba(82, 154, 236, 0.15);
            --success-light: rgba(15, 123, 108, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-primary);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-color), #1a6bc2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }

        .logo-text {
            font-weight: 600;
            font-size: 16px;
        }

        .theme-toggle {
            background: var(--bg-hover);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 24px;
        }

        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .session-card {
            background: linear-gradient(135deg, var(--accent-light), transparent);
            border: 2px solid var(--accent-color);
        }

        .session-name {
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            padding: 6px 10px;
            border: 1px solid transparent;
            border-radius: 6px;
            background: transparent;
            color: var(--text-primary);
        }

        .session-name:focus {
            outline: none;
            background: var(--bg-secondary);
            border-color: var(--accent-color);
        }

        .session-time {
            font-size: 12px;
            color: var(--text-muted);
            margin: 4px 0;
        }

        .session-mode-display {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 8px 0;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .session-mode-display strong {
            color: var(--warning-color);
            font-size: 15px;
        }

        .session-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .session-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            background: var(--bg-secondary);
        }

        .session-item:hover {
            background: var(--bg-tertiary);
        }

        .session-item.active {
            background: var(--accent-light);
            border: 1px solid var(--accent-color);
        }

        .session-item-info {
            flex: 1;
            min-width: 0;
        }

        .session-item-name {
            font-size: 14px;
            font-weight: 500;
        }

        .session-item-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .session-item-delete {
            background: none;
            border: none;
            color: var(--error-color);
            cursor: pointer;
            padding: 6px 10px;
            font-size: 16px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .session-item-delete:hover {
            background: rgba(235, 87, 87, 0.15);
        }

        .new-session-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .mode-selector {
            margin: 8px 0;
        }

        .mode-buttons {
            display: flex;
            gap: 8px;
            margin-top: 6px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .mode-btn:hover {
            border-color: var(--accent-color);
            background: var(--bg-tertiary);
        }

        .mode-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .trade-value-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--warning-color);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 6px;
        }

        .btn-icon {
            background: var(--bg-hover);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
        }

        .btn-primary:hover {
            background: #1a6bc2;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-success:hover {
            background: #0d6b5e;
        }

        .factor-header {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .factor-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 180px;
            overflow-y: auto;
        }

        .factor-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .factor-item:hover {
            background: var(--bg-hover);
        }

        .factor-item.selected {
            background: var(--accent-light);
            border-color: var(--accent-color);
        }

        .drag-handle {
            cursor: grab;
            color: var(--text-muted);
            opacity: 0.5;
        }

        .factor-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
            cursor: pointer;
        }

        .factor-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .factor-delete {
            background: none;
            border: none;
            color: var(--error-color);
            cursor: pointer;
            padding: 4px;
            opacity: 0.5;
        }

        .factor-item:hover .factor-delete {
            opacity: 1;
        }

        .add-factor {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .add-factor input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .add-factor input:focus {
            border-color: var(--accent-color);
        }

        .record-card {
            background: linear-gradient(135deg, var(--success-light), transparent);
            border: 2px solid var(--success-color);
        }

        .selected-factors-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            min-height: 32px;
            margin-bottom: 12px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .preview-chip {
            background: var(--accent-color);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .preview-empty {
            color: var(--text-muted);
            font-size: 13px;
            font-style: italic;
        }

        .note-section {
            margin-bottom: 12px;
        }

        .note-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: block;
        }

        .note-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            min-height: 50px;
            outline: none;
        }

        .note-input:focus {
            border-color: var(--accent-color);
        }

        .value-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .value-input:focus {
            border-color: var(--accent-color);
        }

        .image-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 12px;
            position: relative;
        }

        .image-upload-area:hover {
            border-color: var(--accent-color);
            background: var(--bg-hover);
        }

        .image-upload-area.has-image {
            border-style: solid;
            padding: 8px;
        }

        .image-upload-text {
            font-size: 12px;
            color: var(--text-muted);
        }

        .image-upload-text span {
            color: var(--accent-color);
            font-weight: 500;
        }

        .image-preview {
            max-width: 100%;
            max-height: 120px;
            border-radius: 6px;
            display: block;
            margin: 0 auto;
        }

        .image-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--error-color);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }

        .trade-count {
            text-align: center;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-top: 12px;
        }

        .trade-count-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--success-color);
        }

        .trade-count-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .results-table th {
            font-weight: 600;
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            cursor: pointer;
        }

        .results-table th:hover {
            background: var(--bg-tertiary);
        }

        .results-table tbody tr:hover {
            background: var(--bg-hover);
        }

        .model-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .model-chip {
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .percentage-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .percentage-track {
            flex: 1;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .percentage-fill {
            height: 100%;
            background: var(--accent-color);
            border-radius: 4px;
        }

        .percentage-fill.top {
            background: var(--success-color);
        }

        .percentage-value {
            min-width: 50px;
            text-align: right;
            font-weight: 600;
            font-size: 13px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .chart-container {
            height: 300px;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .trade-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 500px;
            overflow-y: auto;
        }

        .trade-item {
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }

        .trade-item:hover {
            background: var(--bg-tertiary);
        }

        .trade-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            cursor: pointer;
            gap: 8px;
        }

        .trade-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .trade-toggle {
            font-size: 10px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .trade-item.expanded .trade-toggle {
            transform: rotate(90deg);
        }

        .trade-number {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            min-width: 30px;
        }

        .trade-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .trade-factors-inline {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            flex: 1;
        }

        .trade-has-content {
            display: flex;
            gap: 6px;
            color: var(--text-muted);
            font-size: 11px;
        }

        .trade-body {
            display: none;
            padding: 0 14px 14px 14px;
            border-top: 1px solid var(--border-color);
        }

        .trade-item.expanded .trade-body {
            display: block;
            padding-top: 14px;
        }

        .trade-note-display {
            font-size: 13px;
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .trade-image-container {
            position: relative;
            margin-bottom: 10px;
        }

        .trade-image-display {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 14px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            cursor: zoom-out;
        }

        .modal.show {
            display: flex;
        }

        .modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .hidden-input {
            display: none;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">T</div><span class="logo-text">Trading Model Journal</span>
        </div>
        <button class="theme-toggle" id="theme-btn">Dark Mode</button>
    </header>
    <div class="container">
        <div class="left-column">
            <div class="card session-card">
                <div class="card-title">Phien hien tai</div>
                <input type="text" class="session-name" id="current-session-name" value="Phien Test 1">
                <div class="session-time" id="current-session-time">Tao luc: --</div>
                <div class="session-mode-display">Mode: <strong id="current-mode-display">RR</strong></div>

                <div class="new-session-section">
                    <div class="card-title" style="margin-bottom: 8px; font-size: 13px;">Tao phien moi</div>
                    <div class="mode-selector">
                        <label class="note-label">Chon mode truoc khi tao:</label>
                        <div class="mode-buttons" id="mode-buttons">
                            <button type="button" class="mode-btn active" id="mode-RR">RR</button>
                            <button type="button" class="mode-btn" id="mode-dollar">$</button>
                            <button type="button" class="mode-btn" id="mode-percent">%</button>
                        </div>
                    </div>
                    <button type="button" class="btn-primary" id="btn-new-session">+ Tao phien moi</button>
                </div>

                <div class="card-title" style="margin-top: 16px; font-size: 13px;">Danh sach phien <span
                        class="card-subtitle" id="session-count">0</span></div>
                <div class="session-list" id="session-list"></div>
            </div>
            <div class="card">
                <div class="card-title">Factors <span class="card-subtitle" id="factor-count">0 selected</span></div>
                <div class="factor-header">
                    <button type="button" class="btn-icon" id="btn-select-all" title="Select All">+</button>
                    <button type="button" class="btn-icon" id="btn-deselect-all" title="Deselect All">-</button>
                </div>
                <div class="factor-list" id="factor-list"></div>
                <div class="add-factor">
                    <input type="text" id="new-factor" placeholder="Factor moi...">
                    <button type="button" class="btn-secondary" id="btn-add-factor">+ Them</button>
                </div>
            </div>
            <div class="card record-card">
                <div class="card-title">Ghi Trade</div>
                <div class="selected-factors-preview" id="selected-preview"><span class="preview-empty">Chon factors o
                        tren</span></div>
                <div class="note-section">
                    <label class="note-label">Gia tri (<span id="mode-label">RR</span>)</label>
                    <input type="number" class="value-input" id="trade-value" placeholder="Nhap gia tri..." step="0.01">
                </div>
                <div class="note-section">
                    <label class="note-label">Ghi chu (tuy chon)</label>
                    <textarea class="note-input" id="trade-note" placeholder="Nhap ghi chu..."></textarea>
                </div>
                <div class="note-section">
                    <label class="note-label">Anh (Ctrl+V hoac click)</label>
                    <div class="image-upload-area" id="image-upload-area">
                        <div class="image-upload-text"><span>Click chon</span> hoac Ctrl+V</div>
                    </div>
                    <input type="file" class="hidden-input" id="image-input" accept="image/*">
                </div>
                <button type="button" class="btn-primary btn-success" id="btn-record" disabled>Ghi nhan Trade</button>
                <div class="trade-count">
                    <div class="trade-count-number" id="trade-count">0</div>
                    <div class="trade-count-label">trades</div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="tabs">
                <button type="button" class="tab active" id="tab-stats">Thong ke</button>
                <button type="button" class="tab" id="tab-charts">Charts</button>
                <button type="button" class="tab" id="tab-history">Trades</button>
            </div>
            <div class="tab-panel active" id="panel-stats">
                <div id="stats-empty" class="empty-state">
                    <div class="empty-state-icon">-</div>
                    <p>Ghi trades de xem thong ke</p>
                </div>
                <div id="stats-content" style="display: none;">
                    <div class="stats-summary">
                        <div class="stat-card">
                            <div class="stat-value" id="total-trades">0</div>
                            <div class="stat-label">Tong Trades</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="unique-models">0</div>
                            <div class="stat-label">Models</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="top-model-pct">0%</div>
                            <div class="stat-label">Top Model</div>
                        </div>
                        <div class="stat-card"
                            style="background: linear-gradient(135deg, rgba(203, 145, 47, 0.2), transparent);">
                            <div class="stat-value" id="total-value" style="color: var(--warning-color);">0</div>
                            <div class="stat-label" id="total-value-label">Tong RR</div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th id="sort-model">Model</th>
                                    <th id="sort-count">So lan</th>
                                    <th id="sort-pct">Ty le %</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="tab-panel" id="panel-charts">
                <div id="charts-empty" class="empty-state">
                    <div class="empty-state-icon">-</div>
                    <p>Ghi trades de xem bieu do</p>
                </div>
                <div id="charts-content" style="display: none;">
                    <div class="chart-title">Phan bo Model</div>
                    <div class="chart-container"><canvas id="barChart"></canvas></div>
                    <div class="chart-title">Ty le %</div>
                    <div class="chart-container"><canvas id="pieChart"></canvas></div>
                </div>
            </div>
            <div class="tab-panel" id="panel-history">
                <div id="history-empty" class="empty-state">
                    <div class="empty-state-icon">-</div>
                    <p>Chua co trades</p>
                </div>
                <div id="history-content" style="display: none;">
                    <div
                        style="display: flex; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                        <button type="button" class="btn-secondary" id="btn-export">Export CSV</button>
                        <button type="button" class="btn-secondary" id="btn-clear-trades"
                            style="color: var(--error-color);">Xoa trades</button>
                    </div>
                    <div class="trade-list" id="trade-list"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="image-modal"><img id="modal-image" src="" alt="Preview"></div>
    <script>
        var factors = [
            { id: '1', name: 'Factor A', selected: false },
            { id: '2', name: 'Factor B', selected: false },
            { id: '3', name: 'Factor C', selected: false },
            { id: '4', name: 'Factor D', selected: false },
            { id: '5', name: 'Factor E', selected: false }
        ];
        var sessions = [];
        var currentSessionId = null;
        var currentImage = null;
        var sortField = 'percentage';
        var sortOrder = 'desc';
        var barChart = null;
        var pieChart = null;
        var expandedTradeId = null;
        var selectedNewMode = 'RR';

        function getCurrentSession() {
            for (var i = 0; i < sessions.length; i++) {
                if (sessions[i].id === currentSessionId) return sessions[i];
            }
            return null;
        }

        function loadState() {
            try {
                var sf = localStorage.getItem('tj-factors');
                var ss = localStorage.getItem('tj-sessions');
                var sc = localStorage.getItem('tj-current-session');
                var st = localStorage.getItem('trading-theme');
                if (sf) factors = JSON.parse(sf);
                if (ss) sessions = JSON.parse(ss);
                if (sc) currentSessionId = sc;
                if (st === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    document.getElementById('theme-btn').textContent = 'Light Mode';
                }
                if (sessions.length === 0) createNewSession();
                else if (!currentSessionId || !getCurrentSession()) currentSessionId = sessions[0].id;
            } catch (e) { console.error(e); createNewSession(); }
        }

        function saveFactors() { localStorage.setItem('tj-factors', JSON.stringify(factors)); }
        function saveSessions() { localStorage.setItem('tj-sessions', JSON.stringify(sessions)); localStorage.setItem('tj-current-session', currentSessionId); }

        function toggleTheme() {
            var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.documentElement.setAttribute('data-theme', isDark ? '' : 'dark');
            document.getElementById('theme-btn').textContent = isDark ? 'Dark Mode' : 'Light Mode';
            localStorage.setItem('trading-theme', isDark ? 'light' : 'dark');
            updateCharts();
        }

        function createNewSession() {
            var s = { id: Date.now().toString(), name: 'Phien Test ' + (sessions.length + 1), createdAt: Date.now(), trades: [], mode: selectedNewMode };
            sessions.unshift(s);
            currentSessionId = s.id;
            saveSessions();
            renderAll();
        }

        function selectNewMode(mode) {
            selectedNewMode = mode;
            document.getElementById('mode-RR').className = 'mode-btn' + (mode === 'RR' ? ' active' : '');
            document.getElementById('mode-dollar').className = 'mode-btn' + (mode === '$' ? ' active' : '');
            document.getElementById('mode-percent').className = 'mode-btn' + (mode === '%' ? ' active' : '');
        }

        function updateCurrentSessionDisplay() {
            var s = getCurrentSession();
            if (s) {
                document.getElementById('current-session-name').value = s.name;
                document.getElementById('current-session-time').textContent = 'Tao luc: ' + formatDate(s.createdAt);
                document.getElementById('current-mode-display').textContent = s.mode || 'RR';
                document.getElementById('mode-label').textContent = s.mode || 'RR';
            }
        }

        function switchSession(id) {
            currentSessionId = id;
            for (var i = 0; i < factors.length; i++) factors[i].selected = false;
            clearTradeInputs();
            expandedTradeId = null;
            saveSessions();
            renderAll();
        }

        function updateSessionName() {
            var s = getCurrentSession();
            var name = document.getElementById('current-session-name').value;
            if (s && name.trim()) {
                s.name = name.trim();
                saveSessions();
                renderSessionList();
            }
        }

        function deleteSession(id) {
            if (sessions.length <= 1) {
                alert('Can it nhat 1 phien!');
                return;
            }
            if (confirm('Xoa phien nay?')) {
                var newSessions = [];
                for (var i = 0; i < sessions.length; i++) {
                    if (sessions[i].id !== id) newSessions.push(sessions[i]);
                }
                sessions = newSessions;
                if (currentSessionId === id) currentSessionId = sessions[0].id;
                saveSessions();
                renderAll();
            }
        }

        function renderSessionList() {
            document.getElementById('session-count').textContent = sessions.length + ' phien';
            var html = '';
            for (var i = 0; i < sessions.length; i++) {
                var s = sessions[i];
                var isActive = s.id === currentSessionId;
                html += '<div class="session-item ' + (isActive ? 'active' : '') + '" data-id="' + s.id + '">';
                html += '<div class="session-item-info" data-action="switch" data-id="' + s.id + '"><div class="session-item-name">' + s.name + ' [' + (s.mode || 'RR') + ']</div>';
                html += '<div class="session-item-meta">' + formatDate(s.createdAt) + ' - ' + s.trades.length + ' trades</div></div>';
                html += '<button type="button" class="session-item-delete" data-action="delete" data-id="' + s.id + '">X</button>';
                html += '</div>';
            }
            document.getElementById('session-list').innerHTML = html;
            updateCurrentSessionDisplay();
        }

        function formatDate(ts) { return new Date(ts).toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }

        function renderFactors() {
            var selected = [];
            for (var i = 0; i < factors.length; i++) {
                if (factors[i].selected) selected.push(factors[i]);
            }
            document.getElementById('factor-count').textContent = selected.length + ' selected';
            var html = '';
            for (var i = 0; i < factors.length; i++) {
                var f = factors[i];
                html += '<div class="factor-item ' + (f.selected ? 'selected' : '') + '" data-id="' + f.id + '">';
                html += '<span class="drag-handle">::</span>';
                html += '<input type="checkbox" class="factor-checkbox" ' + (f.selected ? 'checked' : '') + ' data-id="' + f.id + '">';
                html += '<span class="factor-name" data-id="' + f.id + '">' + f.name + '</span>';
                html += '<button type="button" class="factor-delete" data-id="' + f.id + '">X</button>';
                html += '</div>';
            }
            document.getElementById('factor-list').innerHTML = html;
            updateSelectedPreview();
            updateRecordButton();
        }

        function updateSelectedPreview() {
            var selected = [];
            for (var i = 0; i < factors.length; i++) {
                if (factors[i].selected) selected.push(factors[i]);
            }
            if (selected.length === 0) {
                document.getElementById('selected-preview').innerHTML = '<span class="preview-empty">Chon factors o tren</span>';
            } else {
                var html = '';
                for (var i = 0; i < selected.length; i++) {
                    html += '<span class="preview-chip">' + selected[i].name + '</span>';
                }
                document.getElementById('selected-preview').innerHTML = html;
            }
        }

        function updateRecordButton() {
            var count = 0;
            for (var i = 0; i < factors.length; i++) {
                if (factors[i].selected) count++;
            }
            document.getElementById('btn-record').disabled = count === 0;
        }

        function toggleFactor(id) {
            for (var i = 0; i < factors.length; i++) {
                if (factors[i].id === id) {
                    factors[i].selected = !factors[i].selected;
                    break;
                }
            }
            renderFactors();
        }

        function selectAll() {
            for (var i = 0; i < factors.length; i++) factors[i].selected = true;
            renderFactors();
        }

        function deselectAll() {
            for (var i = 0; i < factors.length; i++) factors[i].selected = false;
            renderFactors();
        }

        function addFactor() {
            var input = document.getElementById('new-factor');
            var name = input.value.trim();
            if (name) {
                factors.push({ id: Date.now().toString(), name: name, selected: false });
                input.value = '';
                renderFactors();
                saveFactors();
            }
        }

        function deleteFactor(id) {
            var newFactors = [];
            for (var i = 0; i < factors.length; i++) {
                if (factors[i].id !== id) newFactors.push(factors[i]);
            }
            factors = newFactors;
            renderFactors();
            saveFactors();
        }

        function handleImageSelect(event) { var file = event.target.files[0]; if (file) processImage(file); }
        function processImage(file) {
            if (!file.type.startsWith('image/')) return;
            var reader = new FileReader();
            reader.onload = function (e) { currentImage = e.target.result; showImagePreview(); };
            reader.readAsDataURL(file);
        }
        function showImagePreview() {
            var area = document.getElementById('image-upload-area');
            area.classList.add('has-image');
            area.innerHTML = '<img class="image-preview" src="' + currentImage + '" alt="Preview"><button type="button" class="image-remove" id="btn-remove-image">X</button>';
        }
        function removeImage() {
            currentImage = null;
            var area = document.getElementById('image-upload-area');
            area.classList.remove('has-image');
            area.innerHTML = '<div class="image-upload-text"><span>Click chon</span> hoac Ctrl+V</div>';
            document.getElementById('image-input').value = '';
        }

        function clearTradeInputs() {
            document.getElementById('trade-note').value = '';
            document.getElementById('trade-value').value = '';
            removeImage();
        }

        function recordTrade() {
            var session = getCurrentSession();
            if (!session) return;
            var selected = [];
            for (var i = 0; i < factors.length; i++) {
                if (factors[i].selected) selected.push(factors[i]);
            }
            if (selected.length === 0) return;
            var valueInput = document.getElementById('trade-value').value;
            var factorNames = [];
            for (var i = 0; i < selected.length; i++) factorNames.push(selected[i].name);
            factorNames.sort();
            var trade = {
                id: Date.now().toString(),
                timestamp: Date.now(),
                factors: factorNames,
                value: valueInput ? parseFloat(valueInput) : null,
                note: document.getElementById('trade-note').value.trim() || null,
                image: currentImage || null
            };
            session.trades.unshift(trade);
            for (var i = 0; i < factors.length; i++) factors[i].selected = false;
            clearTradeInputs();
            saveSessions();
            renderAll();
            var btn = document.getElementById('btn-record');
            btn.textContent = 'Da ghi!';
            setTimeout(function () { btn.textContent = 'Ghi nhan Trade'; }, 800);
        }

        function clearSessionTrades() { var s = getCurrentSession(); if (s && confirm('Xoa tat ca trades?')) { s.trades = []; saveSessions(); renderAll(); } }
        function deleteTrade(id) {
            var s = getCurrentSession();
            if (s) {
                var newTrades = [];
                for (var i = 0; i < s.trades.length; i++) {
                    if (s.trades[i].id !== id) newTrades.push(s.trades[i]);
                }
                s.trades = newTrades;
                saveSessions();
                renderAll();
            }
        }
        function toggleTrade(id) { expandedTradeId = expandedTradeId === id ? null : id; renderTradeHistory(); }

        function getModelStats() {
            var s = getCurrentSession();
            if (!s || s.trades.length === 0) return [];
            var stats = {};
            for (var i = 0; i < s.trades.length; i++) {
                var t = s.trades[i];
                var key = t.factors.join('+');
                if (!stats[key]) stats[key] = { factors: t.factors, count: 0, totalValue: 0 };
                stats[key].count++;
                if (t.value !== null && t.value !== undefined) {
                    stats[key].totalValue += t.value;
                }
            }
            var total = s.trades.length;
            var arr = [];
            for (var key in stats) {
                arr.push({
                    model: key,
                    factors: stats[key].factors,
                    count: stats[key].count,
                    percentage: (stats[key].count / total) * 100,
                    totalValue: stats[key].totalValue
                });
            }
            arr.sort(function (a, b) {
                if (sortOrder === 'asc') {
                    return sortField === 'model' ? a.model.localeCompare(b.model) : a[sortField] - b[sortField];
                } else {
                    return sortField === 'model' ? b.model.localeCompare(a.model) : b[sortField] - a[sortField];
                }
            });
            return arr;
        }

        function updateResults() {
            var s = getCurrentSession();
            var trades = s ? s.trades : [];
            var mode = s ? (s.mode || 'RR') : 'RR';
            document.getElementById('trade-count').textContent = trades.length;
            if (trades.length === 0) {
                document.getElementById('stats-empty').style.display = 'block';
                document.getElementById('stats-content').style.display = 'none';
                document.getElementById('charts-empty').style.display = 'block';
                document.getElementById('charts-content').style.display = 'none';
                document.getElementById('history-empty').style.display = 'block';
                document.getElementById('history-content').style.display = 'none';
                return;
            }
            document.getElementById('stats-empty').style.display = 'none';
            document.getElementById('stats-content').style.display = 'block';
            var stats = getModelStats();
            var maxPct = 0;
            for (var i = 0; i < stats.length; i++) {
                if (stats[i].percentage > maxPct) maxPct = stats[i].percentage;
            }
            document.getElementById('total-trades').textContent = trades.length;
            document.getElementById('unique-models').textContent = stats.length;
            document.getElementById('top-model-pct').textContent = maxPct.toFixed(1) + '%';

            var totalVal = 0;
            for (var i = 0; i < trades.length; i++) {
                if (trades[i].value !== null && trades[i].value !== undefined) {
                    totalVal += trades[i].value;
                }
            }
            document.getElementById('total-value').textContent = totalVal.toFixed(2);
            document.getElementById('total-value-label').textContent = 'Tong ' + mode;

            var html = '';
            for (var i = 0; i < stats.length; i++) {
                var st = stats[i];
                html += '<tr><td><div class="model-chips">';
                for (var j = 0; j < st.factors.length; j++) {
                    html += '<span class="model-chip">' + st.factors[j] + '</span>';
                }
                if (st.totalValue !== 0) {
                    html += '<span class="trade-value-badge">' + st.totalValue.toFixed(2) + ' ' + mode + '</span>';
                }
                html += '</div></td>';
                html += '<td>' + st.count + '</td>';
                html += '<td><div class="percentage-bar"><div class="percentage-track"><div class="percentage-fill ' + (st.percentage === maxPct ? 'top' : '') + '" style="width: ' + (st.percentage / maxPct * 100) + '%"></div></div><span class="percentage-value">' + st.percentage.toFixed(1) + '%</span></div></td></tr>';
            }
            document.getElementById('results-tbody').innerHTML = html;
        }

        function sortTable(field) {
            if (sortField === field) sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            else { sortField = field; sortOrder = 'desc'; }
            updateResults();
        }

        function updateCharts() {
            var stats = getModelStats().slice(0, 10);
            if (stats.length === 0) return;
            document.getElementById('charts-empty').style.display = 'none';
            document.getElementById('charts-content').style.display = 'block';
            var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            var textColor = isDark ? 'rgba(255,255,255,0.9)' : '#37352f';
            var gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(55,53,47,0.1)';
            var colors = ['#2383e2', '#0f7b6c', '#cb912f', '#9b59b6', '#eb5757', '#3498db', '#1abc9c', '#f39c12', '#e74c3c', '#2ecc71'];

            var labels = [];
            var barData = [];
            var pieData = [];
            for (var i = 0; i < stats.length; i++) {
                labels.push(stats[i].model);
                barData.push(stats[i].percentage);
                pieData.push(stats[i].count);
            }

            if (barChart) barChart.destroy();
            barChart = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: { labels: labels, datasets: [{ data: barData, backgroundColor: colors, borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100, grid: { color: gridColor }, ticks: { color: textColor, callback: function (v) { return v + '%'; } } }, y: { grid: { display: false }, ticks: { color: textColor } } } }
            });

            if (pieChart) pieChart.destroy();
            pieChart = new Chart(document.getElementById('pieChart'), {
                type: 'pie',
                data: { labels: labels, datasets: [{ data: pieData, backgroundColor: colors, borderWidth: 2, borderColor: isDark ? '#191919' : '#fff' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: textColor } } } }
            });
        }

        function renderTradeHistory() {
            var s = getCurrentSession();
            var trades = s ? s.trades : [];
            var mode = s ? (s.mode || 'RR') : 'RR';
            if (trades.length === 0) {
                document.getElementById('history-empty').style.display = 'block';
                document.getElementById('history-content').style.display = 'none';
                return;
            }
            document.getElementById('history-empty').style.display = 'none';
            document.getElementById('history-content').style.display = 'block';

            var html = '';
            for (var i = 0; i < trades.length; i++) {
                var t = trades[i];
                var isExpanded = expandedTradeId === t.id;
                var hasNote = t.note;
                var hasImage = t.image;
                var hasValue = t.value !== null && t.value !== undefined;

                html += '<div class="trade-item ' + (isExpanded ? 'expanded' : '') + '" data-id="' + t.id + '">';
                html += '<div class="trade-header" data-action="toggle" data-id="' + t.id + '">';
                html += '<div class="trade-header-left">';
                html += '<span class="trade-toggle">></span>';
                html += '<span class="trade-number">#' + (trades.length - i) + '</span>';
                html += '<div class="trade-factors-inline">';
                for (var j = 0; j < t.factors.length; j++) {
                    html += '<span class="model-chip">' + t.factors[j] + '</span>';
                }
                if (hasValue) {
                    html += '<span class="trade-value-badge">' + t.value + ' ' + mode + '</span>';
                }
                html += '</div></div>';
                html += '<div style="display: flex; align-items: center; gap: 8px;">';
                html += '<span class="trade-meta">' + formatDate(t.timestamp) + '</span>';
                html += '<div class="trade-has-content">' + (hasNote ? '[N]' : '') + (hasImage ? '[I]' : '') + '</div>';
                html += '<button type="button" class="btn-icon" data-action="delete-trade" data-id="' + t.id + '" style="color: var(--error-color)" title="Xoa">X</button>';
                html += '</div></div>';

                html += '<div class="trade-body">';
                if (hasNote) {
                    html += '<div class="trade-note-display">[Note] ' + t.note + '</div>';
                }
                if (hasImage) {
                    html += '<div class="trade-image-container">';
                    html += '<img class="trade-image-display" src="' + t.image + '" data-action="show-modal" alt="Trade image">';
                    html += '</div>';
                }
                html += '</div></div>';
            }
            document.getElementById('trade-list').innerHTML = html;
        }

        function showModal(src) { document.getElementById('modal-image').src = src; document.getElementById('image-modal').classList.add('show'); }
        function closeModal() { document.getElementById('image-modal').classList.remove('show'); }

        function exportCSV() {
            var stats = getModelStats();
            if (stats.length === 0) return;
            var s = getCurrentSession();
            var mode = s ? (s.mode || 'RR') : 'RR';
            var csv = 'Model,So lan,Ty le,Tong ' + mode + '\n';
            for (var i = 0; i < stats.length; i++) {
                csv += stats[i].model + ',' + stats[i].count + ',' + stats[i].percentage.toFixed(2) + '%,' + stats[i].totalValue.toFixed(2) + '\n';
            }
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = s.name + '_' + new Date().toISOString().slice(0, 10) + '.csv';
            a.click();
        }

        function switchTab(tabName) {
            var tabs = document.querySelectorAll('.tab');
            var panels = document.querySelectorAll('.tab-panel');
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
            for (var i = 0; i < panels.length; i++) panels[i].classList.remove('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('panel-' + tabName).classList.add('active');
            if (tabName === 'charts') updateCharts();
        }

        function renderAll() { renderSessionList(); renderFactors(); updateResults(); renderTradeHistory(); }

        // Event listeners
        document.getElementById('theme-btn').addEventListener('click', toggleTheme);
        document.getElementById('btn-new-session').addEventListener('click', createNewSession);
        document.getElementById('btn-select-all').addEventListener('click', selectAll);
        document.getElementById('btn-deselect-all').addEventListener('click', deselectAll);
        document.getElementById('btn-add-factor').addEventListener('click', addFactor);
        document.getElementById('btn-record').addEventListener('click', recordTrade);
        document.getElementById('btn-export').addEventListener('click', exportCSV);
        document.getElementById('btn-clear-trades').addEventListener('click', clearSessionTrades);
        document.getElementById('current-session-name').addEventListener('change', updateSessionName);
        document.getElementById('new-factor').addEventListener('keypress', function (e) { if (e.key === 'Enter') addFactor(); });
        document.getElementById('image-upload-area').addEventListener('click', function (e) {
            if (e.target.id === 'btn-remove-image') { e.stopPropagation(); removeImage(); }
            else { document.getElementById('image-input').click(); }
        });
        document.getElementById('image-input').addEventListener('change', handleImageSelect);
        document.getElementById('image-modal').addEventListener('click', closeModal);

        document.getElementById('mode-RR').addEventListener('click', function () { selectNewMode('RR'); });
        document.getElementById('mode-dollar').addEventListener('click', function () { selectNewMode('$'); });
        document.getElementById('mode-percent').addEventListener('click', function () { selectNewMode('%'); });

        document.getElementById('tab-stats').addEventListener('click', function () { switchTab('stats'); });
        document.getElementById('tab-charts').addEventListener('click', function () { switchTab('charts'); });
        document.getElementById('tab-history').addEventListener('click', function () { switchTab('history'); });

        document.getElementById('sort-model').addEventListener('click', function () { sortTable('model'); });
        document.getElementById('sort-count').addEventListener('click', function () { sortTable('count'); });
        document.getElementById('sort-pct').addEventListener('click', function () { sortTable('percentage'); });

        // Delegated events
        document.getElementById('session-list').addEventListener('click', function (e) {
            var target = e.target;
            while (target && target !== this) {
                if (target.dataset.action === 'delete') {
                    e.stopPropagation();
                    deleteSession(target.dataset.id);
                    return;
                }
                if (target.dataset.action === 'switch' || target.classList.contains('session-item')) {
                    var id = target.dataset.id;
                    if (!id) {
                        var info = target.querySelector('[data-id]');
                        if (info) id = info.dataset.id;
                    }
                    if (id) switchSession(id);
                    return;
                }
                target = target.parentElement;
            }
        });

        document.getElementById('factor-list').addEventListener('click', function (e) {
            var target = e.target;
            if (target.classList.contains('factor-delete')) {
                e.stopPropagation();
                deleteFactor(target.dataset.id);
                return;
            }
            if (target.classList.contains('factor-checkbox')) {
                e.stopPropagation();
                toggleFactor(target.dataset.id);
                return;
            }
            while (target && target !== this) {
                if (target.classList.contains('factor-item')) {
                    toggleFactor(target.dataset.id);
                    return;
                }
                target = target.parentElement;
            }
        });

        document.getElementById('trade-list').addEventListener('click', function (e) {
            var target = e.target;
            if (target.dataset.action === 'delete-trade') {
                e.stopPropagation();
                deleteTrade(target.dataset.id);
                return;
            }
            if (target.dataset.action === 'show-modal') {
                showModal(target.src);
                return;
            }
            while (target && target !== this) {
                if (target.dataset.action === 'toggle') {
                    toggleTrade(target.dataset.id);
                    return;
                }
                target = target.parentElement;
            }
        });

        document.addEventListener('paste', function (e) {
            var items = e.clipboardData.items;
            for (var i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    processImage(items[i].getAsFile());
                    e.preventDefault();
                    break;
                }
            }
        });

        loadState();
        renderAll();
    </script>
</body>

</html>